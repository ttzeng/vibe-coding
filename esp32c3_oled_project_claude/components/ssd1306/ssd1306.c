#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "esp_log.h"
#include "driver/i2c_master.h"
#include "ssd1306.h"

static const char *TAG = "SSD1306";

// SSD1306 Commands (same as before)
#define SSD1306_CMD_SET_CONTRAST            0x81
#define SSD1306_CMD_DISPLAY_ALL_ON_RESUME   0xA4
#define SSD1306_CMD_DISPLAY_ALL_ON          0xA5
#define SSD1306_CMD_NORMAL_DISPLAY          0xA6
#define SSD1306_CMD_INVERT_DISPLAY          0xA7
#define SSD1306_CMD_DISPLAY_OFF             0xAE
#define SSD1306_CMD_DISPLAY_ON              0xAF
#define SSD1306_CMD_SET_DISPLAY_OFFSET      0xD3
#define SSD1306_CMD_SET_COMPINS             0xDA
#define SSD1306_CMD_SET_VCOM_DETECT         0xDB
#define SSD1306_CMD_SET_DISPLAY_CLK_DIV     0xD5
#define SSD1306_CMD_SET_PRECHARGE           0xD9
#define SSD1306_CMD_SET_MULTIPLEX           0xA8
#define SSD1306_CMD_SET_LOW_COLUMN          0x00
#define SSD1306_CMD_SET_HIGH_COLUMN         0x10
#define SSD1306_CMD_SET_START_LINE          0x40
#define SSD1306_CMD_MEMORY_ADDR_MODE        0x20
#define SSD1306_CMD_SET_COLUMN_RANGE        0x21
#define SSD1306_CMD_SET_PAGE_RANGE          0x22
#define SSD1306_CMD_COMSCAN_DEC             0xC8
#define SSD1306_CMD_COMSCAN_INC             0xC0
#define SSD1306_CMD_SEGREMAP                0xA0
#define SSD1306_CMD_CHARGE_PUMP             0x8D

#define SSD1306_TIMEOUT_MS                  1000

// Complete 8x16 ASCII font (32-126) - 95 characters
// Each character is 8 pixels wide, 16 pixels tall
// Data is stored as 16 bytes per character (one byte per row)
static const uint8_t font8x16[][16] = {
    // ' ' (32)
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // '!' (33)
    {0x00,0x00,0x18,0x3C,0x3C,0x3C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    // '"' (34)
    {0x00,0x00,0x66,0x66,0x66,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // '#' (35)
    {0x00,0x00,0x6C,0x6C,0xFE,0x6C,0x6C,0x6C,0xFE,0x6C,0x6C,0x00,0x00,0x00,0x00,0x00},
    // '$' (36)
    {0x00,0x10,0x10,0x7C,0xD6,0xD0,0xD0,0x7C,0x16,0x16,0xD6,0x7C,0x10,0x10,0x00,0x00},
    // '%' (37)
    {0x00,0x00,0x00,0x00,0xC2,0xC6,0x0C,0x18,0x30,0x60,0xC6,0x86,0x00,0x00,0x00,0x00},
    // '&' (38)
    {0x00,0x00,0x38,0x6C,0x6C,0x38,0x76,0xDC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    // ''' (39)
    {0x00,0x00,0x30,0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // '(' (40)
    {0x00,0x00,0x0C,0x18,0x30,0x30,0x30,0x30,0x30,0x30,0x18,0x0C,0x00,0x00,0x00,0x00},
    // ')' (41)
    {0x00,0x00,0x30,0x18,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x18,0x30,0x00,0x00,0x00,0x00},
    // '*' (42)
    {0x00,0x00,0x00,0x00,0x99,0x5A,0x3C,0xFF,0x3C,0x5A,0x99,0x00,0x00,0x00,0x00,0x00},
    // '+' (43)
    {0x00,0x00,0x00,0x18,0x18,0x18,0xFF,0xFF,0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
    // ',' (44)
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x18,0x30,0x00,0x00,0x00},
    // '-' (45)
    {0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // '.' (46)
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    // '/' (47)
    {0x00,0x00,0x00,0x02,0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,0x00,0x00,0x00,0x00},
    // '0' (48)
    {0x00,0x00,0x3C,0x66,0xC3,0xC3,0xDB,0xDB,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
    // '1' (49)
    {0x00,0x00,0x18,0x38,0x58,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00},
    // '2' (50)
    {0x00,0x00,0x7C,0xC6,0x06,0x0C,0x18,0x30,0x60,0xC0,0xC6,0xFE,0x00,0x00,0x00,0x00},
    // '3' (51)
    {0x00,0x00,0x7C,0xC6,0x06,0x06,0x3C,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // '4' (52)
    {0x00,0x00,0x0C,0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x0C,0x0C,0x1E,0x00,0x00,0x00,0x00},
    // '5' (53)
    {0x00,0x00,0xFE,0xC0,0xC0,0xC0,0xFC,0x0E,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // '6' (54)
    {0x00,0x00,0x38,0x60,0xC0,0xC0,0xFC,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // '7' (55)
    {0x00,0x00,0xFE,0xC6,0x06,0x06,0x0C,0x18,0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00},
    // '8' (56)
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // '9' (57)
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7E,0x06,0x06,0x06,0x0C,0x78,0x00,0x00,0x00,0x00},
    // ':' (58)
    {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
    // ';' (59)
    {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00},
    // '<' (60)
    {0x00,0x00,0x00,0x06,0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x06,0x00,0x00,0x00,0x00},
    // '=' (61)
    {0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // '>' (62)
    {0x00,0x00,0x00,0x60,0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x60,0x00,0x00,0x00,0x00},
    // '?' (63)
    {0x00,0x00,0x7C,0xC6,0xC6,0x0C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    // '@' (64)
    {0x00,0x00,0x7C,0xC6,0xC6,0xDE,0xDE,0xDE,0xDC,0xC0,0x7C,0x00,0x00,0x00,0x00,0x00},
    // 'A' (65)
    {0x00,0x00,0x10,0x38,0x6C,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    // 'B' (66)
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x66,0x66,0x66,0x66,0xFC,0x00,0x00,0x00,0x00},
    // 'C' (67)
    {0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xC0,0xC0,0xC2,0x66,0x3C,0x00,0x00,0x00,0x00},
    // 'D' (68)
    {0x00,0x00,0xF8,0x6C,0x66,0x66,0x66,0x66,0x66,0x66,0x6C,0xF8,0x00,0x00,0x00,0x00},
    // 'E' (69)
    {0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00},
    // 'F' (70)
    {0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    // 'G' (71)
    {0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xDE,0xC6,0xC6,0x66,0x3A,0x00,0x00,0x00,0x00},
    // 'H' (72)
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    // 'I' (73)
    {0x00,0x00,0x3C,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    // 'J' (74)
    {0x00,0x00,0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0xCC,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00},
    // 'K' (75)
    {0x00,0x00,0xE6,0x66,0x66,0x6C,0x78,0x78,0x6C,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    // 'L' (76)
    {0x00,0x00,0xF0,0x60,0x60,0x60,0x60,0x60,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00},
    // 'M' (77)
    {0x00,0x00,0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    // 'N' (78)
    {0x00,0x00,0xC6,0xE6,0xF6,0xFE,0xDE,0xCE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    // 'O' (79)
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 'P' (80)
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    // 'Q' (81)
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xD6,0xDE,0x7C,0x0C,0x0E,0x00,0x00},
    // 'R' (82)
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x6C,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    // 'S' (83)
    {0x00,0x00,0x7C,0xC6,0xC6,0x60,0x38,0x0C,0x06,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 'T' (84)
    {0x00,0x00,0x7E,0x7E,0x5A,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    // 'U' (85)
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 'V' (86)
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x10,0x00,0x00,0x00,0x00},
    // 'W' (87)
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xD6,0xD6,0xD6,0xFE,0xEE,0x6C,0x00,0x00,0x00,0x00},
    // 'X' (88)
    {0x00,0x00,0xC6,0xC6,0x6C,0x7C,0x38,0x38,0x7C,0x6C,0xC6,0xC6,0x00,0x00,0x00,0x00},
    // 'Y' (89)
    {0x00,0x00,0x66,0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    // 'Z' (90)
    {0x00,0x00,0xFE,0xC6,0x86,0x0C,0x18,0x30,0x60,0xC2,0xC6,0xFE,0x00,0x00,0x00,0x00},
    // '[' (91)
    {0x00,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00},
    // '\' (92)
    {0x00,0x00,0x00,0x80,0xC0,0x60,0x30,0x18,0x0C,0x06,0x02,0x00,0x00,0x00,0x00,0x00},
    // ']' (93)
    {0x00,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00},
    // '^' (94)
    {0x00,0x00,0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // '_' (95)
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00},
    // '`' (96)
    {0x00,0x00,0x0C,0x18,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // 'a' (97)
    {0x00,0x00,0x00,0x00,0x00,0x78,0x0C,0x7C,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    // 'b' (98)
    {0x00,0x00,0xE0,0x60,0x60,0x78,0x6C,0x66,0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00},
    // 'c' (99)
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC0,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 'd' (100)
    {0x00,0x00,0x1C,0x0C,0x0C,0x3C,0x6C,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    // 'e' (101)
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xFE,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 'f' (102)
    {0x00,0x00,0x38,0x6C,0x64,0x60,0xF0,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    // 'g' (103)
    {0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0xCC,0x78,0x00,0x00},
    // 'h' (104)
    {0x00,0x00,0xE0,0x60,0x60,0x6C,0x76,0x66,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    // 'i' (105)
    {0x00,0x00,0x18,0x18,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    // 'j' (106)
    {0x00,0x00,0x06,0x06,0x00,0x0E,0x06,0x06,0x06,0x06,0x06,0x06,0x66,0x66,0x3C,0x00},
    // 'k' (107)
    {0x00,0x00,0xE0,0x60,0x60,0x66,0x6C,0x78,0x78,0x6C,0x66,0xE6,0x00,0x00,0x00,0x00},
    // 'l' (108)
    {0x00,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    // 'm' (109)
    {0x00,0x00,0x00,0x00,0x00,0xEC,0xFE,0xD6,0xD6,0xD6,0xD6,0xC6,0x00,0x00,0x00,0x00},
    // 'n' (110)
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00},
    // 'o' (111)
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 'p' (112)
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00,0x00},
    // 'q' (113)
    {0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0x0C,0x1E,0x00,0x00},
    // 'r' (114)
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x76,0x66,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    // 's' (115)
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0x60,0x38,0x0C,0xC6,0x7C,0x00,0x00,0x00,0x00},
    // 't' (116)
    {0x00,0x00,0x10,0x30,0x30,0xFC,0x30,0x30,0x30,0x30,0x36,0x1C,0x00,0x00,0x00,0x00},
    // 'u' (117)
    {0x00,0x00,0x00,0x00,0x00,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    // 'v' (118)
    {0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x00,0x00,0x00,0x00},
    // 'w' (119)
    {0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xD6,0xD6,0xD6,0xFE,0x6C,0x00,0x00,0x00,0x00},
    // 'x' (120)
    {0x00,0x00,0x00,0x00,0x00,0xC6,0x6C,0x38,0x38,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00},
    // 'y' (121)
    {0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0x7E,0x06,0x0C,0xF8,0x00,0x00},
    // 'z' (122)
    {0x00,0x00,0x00,0x00,0x00,0xFE,0xCC,0x18,0x30,0x60,0xC6,0xFE,0x00,0x00,0x00,0x00},
    // '{' (123)
    {0x00,0x00,0x0E,0x18,0x18,0x18,0x70,0x18,0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x00},
    // '|' (124)
    {0x00,0x00,0x18,0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00},
    // '}' (125)
    {0x00,0x00,0x70,0x18,0x18,0x18,0x0E,0x18,0x18,0x18,0x18,0x70,0x00,0x00,0x00,0x00},
    // '~' (126)
    {0x00,0x00,0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
};

// Rest of the structure and helper functions remain the same...
struct ssd1306_dev {
    i2c_master_dev_handle_t i2c_dev;
    uint8_t dev_addr;
    uint8_t *gram;
};

static esp_err_t ssd1306_write_cmd(ssd1306_handle_t dev, uint8_t cmd)
{
    uint8_t data[2] = {0x00, cmd}; // 0x00 = Command mode
    esp_err_t ret = i2c_master_transmit(dev->i2c_dev, data, 2, SSD1306_TIMEOUT_MS);
    if (ret != ESP_OK) {
        ESP_LOGE(TAG, "Failed to write command 0x%02X: %s", cmd, esp_err_to_name(ret));
    }
    return ret;
}

static esp_err_t ssd1306_write_data(ssd1306_handle_t dev, uint8_t *data, size_t data_len)
{
    // For large data transfers, we need to send in chunks
    const size_t max_chunk_size = 128;
    size_t bytes_sent = 0;
    esp_err_t ret = ESP_OK;
    
    uint8_t *write_buffer = malloc(max_chunk_size + 1);
    if (write_buffer == NULL) {
        ESP_LOGE(TAG, "Failed to allocate write buffer");
        return ESP_ERR_NO_MEM;
    }
    
    write_buffer[0] = 0x40; // Data mode
    
    while (bytes_sent < data_len) {
        size_t chunk_size = (data_len - bytes_sent > max_chunk_size) ? max_chunk_size : (data_len - bytes_sent);
        
        memcpy(&write_buffer[1], &data[bytes_sent], chunk_size);
        
        ret = i2c_master_transmit(dev->i2c_dev, write_buffer, chunk_size + 1, SSD1306_TIMEOUT_MS);
        if (ret != ESP_OK) {
            ESP_LOGE(TAG, "Failed to write data chunk at offset %d: %s", bytes_sent, esp_err_to_name(ret));
            break;
        }
        
        bytes_sent += chunk_size;
    }
    
    free(write_buffer);
    return ret;
}

ssd1306_handle_t ssd1306_create(i2c_master_bus_handle_t bus_handle, uint8_t dev_addr)
{
    ssd1306_handle_t dev = malloc(sizeof(struct ssd1306_dev));
    if (dev == NULL) {
        ESP_LOGE(TAG, "Failed to allocate memory for SSD1306 device");
        return NULL;
    }
    
    dev->gram = malloc(SSD1306_BUFFER_SIZE);
    if (dev->gram == NULL) {
        ESP_LOGE(TAG, "Failed to allocate memory for GRAM");
        free(dev);
        return NULL;
    }
    
    // Add I2C device to the bus
    i2c_device_config_t dev_cfg = {
        .dev_addr_length = I2C_ADDR_BIT_LEN_7,
        .device_address = dev_addr,
        .scl_speed_hz = 400000,
    };
    
    esp_err_t ret = i2c_master_bus_add_device(bus_handle, &dev_cfg, &dev->i2c_dev);
    if (ret != ESP_OK) {
        ESP_LOGE(TAG, "Failed to add I2C device: %s", esp_err_to_name(ret));
        free(dev->gram);
        free(dev);
        return NULL;
    }
    
    dev->dev_addr = dev_addr;
    
    ESP_LOGI(TAG, "SSD1306 device created successfully");
    return dev;
}

void ssd1306_delete(ssd1306_handle_t dev)
{
    if (dev) {
        if (dev->i2c_dev) {
            i2c_master_bus_rm_device(dev->i2c_dev);
        }
        if (dev->gram) {
            free(dev->gram);
        }
        free(dev);
        ESP_LOGI(TAG, "SSD1306 device deleted");
    }
}

esp_err_t ssd1306_init(ssd1306_handle_t dev)
{
    esp_err_t ret;
    
    ESP_LOGI(TAG, "Initializing SSD1306 display...");
    
    // Display OFF
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_DISPLAY_OFF);
    if (ret != ESP_OK) return ret;
    
    // Set display clock divide ratio/oscillator frequency
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_SET_DISPLAY_CLK_DIV);
    if (ret != ESP_OK) return ret;
    ret = ssd1306_write_cmd(dev, 0x80);
    if (ret != ESP_OK) return ret;
    
    // Set multiplex ratio
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_SET_MULTIPLEX);
    if (ret != ESP_OK) return ret;
    ret = ssd1306_write_cmd(dev, SSD1306_HEIGHT - 1);
    if (ret != ESP_OK) return ret;
    
    // Set display offset
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_SET_DISPLAY_OFFSET);
    if (ret != ESP_OK) return ret;
    ret = ssd1306_write_cmd(dev, 0x00);
    if (ret != ESP_OK) return ret;
    
    // Set start line address
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_SET_START_LINE | 0x00);
    if (ret != ESP_OK) return ret;
    
    // Set charge pump
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_CHARGE_PUMP);
    if (ret != ESP_OK) return ret;
    ret = ssd1306_write_cmd(dev, 0x14);
    if (ret != ESP_OK) return ret;
    
    // Set memory addressing mode
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_MEMORY_ADDR_MODE);
    if (ret != ESP_OK) return ret;
    ret = ssd1306_write_cmd(dev, 0x00); // Horizontal addressing mode
    if (ret != ESP_OK) return ret;
    
    // Set segment re-map
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_SEGREMAP | 0x01);
    if (ret != ESP_OK) return ret;
    
    // Set COM output scan direction
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_COMSCAN_DEC);
    if (ret != ESP_OK) return ret;
    
    // Set COM pins hardware configuration
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_SET_COMPINS);
    if (ret != ESP_OK) return ret;
    ret = ssd1306_write_cmd(dev, 0x12);
    if (ret != ESP_OK) return ret;
    
    // Set contrast control
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_SET_CONTRAST);
    if (ret != ESP_OK) return ret;
    ret = ssd1306_write_cmd(dev, 0xCF);
    if (ret != ESP_OK) return ret;
    
    // Set pre-charge period
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_SET_PRECHARGE);
    if (ret != ESP_OK) return ret;
    ret = ssd1306_write_cmd(dev, 0xF1);
    if (ret != ESP_OK) return ret;
    
    // Set VCOM deselect level
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_SET_VCOM_DETECT);
    if (ret != ESP_OK) return ret;
    ret = ssd1306_write_cmd(dev, 0x40);
    if (ret != ESP_OK) return ret;
    
    // Display all on resume
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_DISPLAY_ALL_ON_RESUME);
    if (ret != ESP_OK) return ret;
    
    // Normal display
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_NORMAL_DISPLAY);
    if (ret != ESP_OK) return ret;
    
    // Display ON
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_DISPLAY_ON);
    if (ret != ESP_OK) return ret;
    
    // Clear GRAM
    memset(dev->gram, 0, SSD1306_BUFFER_SIZE);
    
    ESP_LOGI(TAG, "SSD1306 initialization completed successfully");
    return ESP_OK;
}

void ssd1306_clear_screen(ssd1306_handle_t dev, uint8_t chFill)
{
    if (dev && dev->gram) {
        memset(dev->gram, chFill, SSD1306_BUFFER_SIZE);
    }
}

void ssd1306_refresh_gram(ssd1306_handle_t dev)
{
    if (dev == NULL || dev->gram == NULL) {
        ESP_LOGE(TAG, "Invalid device handle");
        return;
    }
    
    esp_err_t ret;
    
    // Set column address range
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_SET_COLUMN_RANGE);
    if (ret != ESP_OK) return;
    ret = ssd1306_write_cmd(dev, 0);
    if (ret != ESP_OK) return;
    ret = ssd1306_write_cmd(dev, SSD1306_WIDTH - 1);
    if (ret != ESP_OK) return;
    
    // Set page address range
    ret = ssd1306_write_cmd(dev, SSD1306_CMD_SET_PAGE_RANGE);
    if (ret != ESP_OK) return;
    ret = ssd1306_write_cmd(dev, 0);
    if (ret != ESP_OK) return;
    ret = ssd1306_write_cmd(dev, (SSD1306_HEIGHT / 8) - 1);
    if (ret != ESP_OK) return;
    
    // Send GRAM data to display
    ssd1306_write_data(dev, dev->gram, SSD1306_BUFFER_SIZE);
}

void ssd1306_draw_point(ssd1306_handle_t dev, uint8_t chXpos, uint8_t chYpos, uint8_t chPoint)
{
    if (dev == NULL || dev->gram == NULL) {
        return;
    }
    
    if (chXpos >= SSD1306_WIDTH || chYpos >= SSD1306_HEIGHT) {
        return;
    }
    
    uint8_t page = chYpos / 8;
    uint8_t bit = chYpos % 8;
    uint16_t gram_index = chXpos + page * SSD1306_WIDTH;
    
    if (chPoint) {
        dev->gram[gram_index] |= (1 << bit);
    } else {
        dev->gram[gram_index] &= ~(1 << bit);
    }
}

void ssd1306_draw_line(ssd1306_handle_t dev, uint8_t chXpos0, uint8_t chYpos0, uint8_t chXpos1, uint8_t chYpos1, uint8_t chMode)
{
    int t;
    int xerr = 0, yerr = 0, delta_x, delta_y, distance;
    int incx, incy, uRow, uCol;
    
    delta_x = chXpos1 - chXpos0;
    delta_y = chYpos1 - chYpos0;
    uRow = chXpos0;
    uCol = chYpos0;
    
    if (delta_x > 0) incx = 1;
    else if (delta_x == 0) incx = 0;
    else {
        incx = -1;
        delta_x = -delta_x;
    }
    
    if (delta_y > 0) incy = 1;
    else if (delta_y == 0) incy = 0;
    else {
        incy = -1;
        delta_y = -delta_y;
    }
    
    if (delta_x > delta_y) distance = delta_x;
    else distance = delta_y;
    
    for (t = 0; t <= distance + 1; t++) {
        ssd1306_draw_point(dev, uRow, uCol, chMode);
        xerr += delta_x;
        yerr += delta_y;
        if (xerr > distance) {
            xerr -= distance;
            uRow += incx;
        }
        if (yerr > distance) {
            yerr -= distance;
            uCol += incy;
        }
    }
}

void ssd1306_draw_rectangle(ssd1306_handle_t dev, uint8_t chXpos0, uint8_t chYpos0, uint8_t chWidth, uint8_t chHeight, uint8_t chMode)
{
    ssd1306_draw_line(dev, chXpos0, chYpos0, chXpos0 + chWidth, chYpos0, chMode);
    ssd1306_draw_line(dev, chXpos0, chYpos0, chXpos0, chYpos0 + chHeight, chMode);
    ssd1306_draw_line(dev, chXpos0, chYpos0 + chHeight, chXpos0 + chWidth, chYpos0 + chHeight, chMode);
    ssd1306_draw_line(dev, chXpos0 + chWidth, chYpos0, chXpos0 + chWidth, chYpos0 + chHeight, chMode);
}

void ssd1306_show_char(ssd1306_handle_t dev, uint8_t chXpos, uint8_t chYpos, uint8_t chChr, uint8_t chSize, uint8_t chMode)
{
    if (dev == NULL) return;
    
    // Check bounds
    if (chXpos >= SSD1306_WIDTH || chYpos >= SSD1306_HEIGHT) return;
    
    // Check if character is printable (ASCII 32-126)
    if (chChr < 32 || chChr > 126) {
        chChr = 32; // Use space for unprintable characters
    }
    
    // Get font index (ASCII offset from space character)
    uint8_t char_index = chChr - 32;
    
    if (chSize == 16) {
        // 8x16 font: each character is 8 pixels wide, 16 pixels tall
        // Font data is stored as 16 bytes per character (one byte per row)
        for (int row = 0; row < 16; row++) {
            uint8_t font_data = font8x16[char_index][row];
            
            // Draw 8 pixels for this row
            for (int col = 0; col < 8; col++) {
                // Check if we're within display bounds
                if ((chXpos + col) < SSD1306_WIDTH && (chYpos + row) < SSD1306_HEIGHT) {
                    // Check bit (MSB first: bit 7 = leftmost pixel)
                    if (font_data & (0x80 >> col)) {
                        ssd1306_draw_point(dev, chXpos + col, chYpos + row, chMode);
                    } else if (chMode == 0) {
                        // If drawing in "erase" mode, clear the pixel
                        ssd1306_draw_point(dev, chXpos + col, chYpos + row, 0);
                    }
                }
            }
        }
    }
}

void ssd1306_show_string(ssd1306_handle_t dev, uint8_t chXpos, uint8_t chYpos, const char *pchString, uint8_t chSize, uint8_t chMode)
{
    uint8_t chXpos0 = chXpos;
    
    if (dev == NULL || pchString == NULL) return;
    
    while (*pchString != '\0') {
        if (chXpos > (SSD1306_WIDTH - 8)) { // 8 pixels wide per character
            chXpos = chXpos0;
            chYpos += chSize;
        }
        if (chYpos > (SSD1306_HEIGHT - chSize)) {
            chYpos = chXpos = 0;
            ssd1306_clear_screen(dev, 0x00);
        }
        
        ssd1306_show_char(dev, chXpos, chYpos, *pchString, chSize, chMode);
        chXpos += 8; // Move to next character position (8 pixels wide)
        pchString++;
    }
}
